<html>
  <head>
    <link type="text/css" rel="stylesheet" media="all" title="CSS" href="./style.css" />
  </head>
  <body>
    <h2>WallHelp (me buying a banana)</h2>
  <!--
    FIRST BLOCK TO SEND ETH FROM ACCOUNT 1
  -->
  <div class="global">
    <div class="p2" class="globalgauche">
      <div class="message p2" id='messageTx'></div>
      <div class="p2" id="solde"></div>
      <p>address <input type='text' value='0xEF2C2a05638f4872f5732DFe5240b2Aa8315AcA1' id='toAddress' size=50/></p>
      <p>Amount <input type='number' value='0.02' id='tips' min=0.01 step="0.01" size=5/> Ether</p>
      <button id="tip-button" class="tip-button"></button>
    </div>
    <div class="container">
      <div id="etherscanview"></div>
      <div id="currentNetWork" class="center"></div>
    </div>
  </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.3.6/web3.min.js" integrity="sha512-jMEcX0Bev3VsCrACqEM3BFZvAMFXJSuTsMu0SttkAdMjquip6p3Oty5bbXrfg4T8n4g5BQYkGKxzLsrSqQgLUQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      let txHash            = ""
      let receiver          = ""
      let chainId           = ""
      let soldeAccount      = ""
      let tipper_addresses
      let nameProvider
      window.onload     = async () => {
        if (window.ethereum) {
          await window.ethereum.send('eth_requestAccounts');
          window.web3 = new Web3(window.ethereum);
          tipper_addresses =  await web3.eth.getAccounts()
          nameProvider = getProviderName(await web3.eth.getChainId());
          getSolde(0)
          let urlEtherUser = nameProvider.explorer + "/address/"+ tipper_addresses
          let urlImgEther = "<a href='" + urlEtherUser + "' target='_blank'><img src='./img/etherscan.png' alt='Etherscan' class='imgetherscan' width='200' height='80'></a>"

          renderMessage(urlImgEther, "#etherscanview","p2")
          renderMessage(nameProvider.name, "#currentNetWork","p2")

        } else { alert("Install Metamask")}
      };


      const tip = async () => {
          renderMessage('Wating user choice ... (pleeeaaase confirm !)', '#messageTx',"p1")
            const my_address = document.querySelector('#toAddress').value;
            try {
              const address = web3.utils.toChecksumAddress(my_address)
            } catch(e) { 
              renderMessage("Should I buy U a right hand 4 XMas ? check address pls", '#messageTx', "p1red")
              console.error('invalid ethereum address', e.message) 
              return
            }

          
          const ethTip = document.querySelector('#tips').value
          tipper_addresses = await web3.eth.getAccounts();

          await web3.eth.sendTransaction({
              to: my_address,
              from: tipper_addresses[0],
              value: web3.utils.toWei(ethTip, 'ether'), 
              gas: 50000,
          })
          .once('transactionHash', (hash) => {
              txHash = hash 
              renderMessage('Processing ... ',"#messageTx", "p1")
          })
          .once('confirmation', (receipt) => {
              getSolde(1)
            })
          .once('receipt', (receipt) => {
            renderMessage("Thanks for so much generosity!! Tx: <br />" + txHash +"", "#messageTx", "p1green");
          })
          .on('error', (err) => {
              renderMessage(err.message,'#messageTx',"p1red")
              console.log(err)
            })
      }

      /* ******************************************************************
      * CHANGEMENT DE PROVIDER : RELOAD
      */
      ethereum.on('chainChanged', handleChainChanged);
      function handleChainChanged(_chainId) {
        // recommendation metamask
        window.location.reload();
      }
      //********************************************************************
      const renderMessage = (message, htmlSelector, pcss) => {
        const messageEl = document.querySelector(htmlSelector)
        messageEl.innerHTML = "<p class='" + pcss +"'>" + message +"</p>"
      }

      const getSolde= async (when) => {
        renderMessage("Updating ca$h balance ...", "#messageTx", "p1red");
        soldeAccount = await web3.eth.getBalance(tipper_addresses[0])
        renderMessage("Ca$h :" + web3.utils.fromWei(soldeAccount) + " ETH", "#solde")
        if (when==0) {
          renderMessage("", "#messageTx");
        }
console.log("Wei Solde = " +soldeAccount)        
      }

      const getProviderName= (chainId) => {
        switch(chainId) {
            case 1: 
            return {
              "name":"Ethereum Main Network",
              "explorer":"https://etherscan.io"
            }
                  break;
            case 3: 
            return {
              "name":"Ropsten",
              "explorer":"https://ropsten.etherscan.io"
            }
                  break;
            case 4: 
            return {
              "name":"Rinkeby",
              "explorer":"https://rinkeby.etherscan.io"
            }
                  break;
            case 5: 
            return {
              "name":"Goerli",
              "explorer":"https://goerli.etherscan.io"
            }
                  break;
            case 42: 
            return {
              "name":"Kovan",
              "explorer":"https://kovan.etherscan.io"
            }
                  break;
            case 97: 
            return {
              "name":"Binance Smart Chain Testnet",
              "explorer":"https://testnet.bscscan.com"
            }
                  break;      
            case 80001: 
            return 'Mumbai'
                  break;      

            default:             
            return {
              "name":"Not yet registered ...",
              "explorer":"https://chainlist.org"
            }

            
          } 
        }

      document.getElementById("tip-button").addEventListener("click", tip);
    </script>
    
  </body>
</html> 

